{% load static %}
<!DOCTYPE html>
<html lang="pt-BR">
<head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-J2MXTGJ8DT"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-J2MXTGJ8DT');
</script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="{% static 'css/style.css' %}">
  <link rel="shortcut icon" href="{% static 'icons/favicon.png' %}" type="image/x-icon">
  <title>Bellafly</title>
</head>
<body>
  <header>
    <h1>ü¶ã Bellafly ü¶ã</h1>
    <form method="get">
      <input type="text" name="q" placeholder="Buscar em todos os produtos..." value="{{ query|default_if_none:'' }}">
      <button type="submit">üîç Pesquisar</button>
      {% if categoria %}
        <input type="hidden" name="categoria" value="{{ categoria }}">
      {% endif %}
    </form>
  </header>

  <button class="menu-toggle" onclick="toggleMenu()">‚ò∞</button>
  
  <div class="overlay" id="overlay" onclick="closeMenu()"></div>

  <nav id="menu" class="sidebar">
    <div class="sidebar-title">Categorias</div>
    <a class="btn {% if categoria == 'perfumaria' %}active{% endif %}" href="?categoria=perfumaria" data-category="perfumaria">
      <span>‚ú® Perfumaria</span>
    </a>
    <a class="btn {% if categoria == 'kits' %}active{% endif %}" href="?categoria=kits" data-category="kits">
      <span>üíÑ Kits de Beleza</span>
    </a>
    <a class="btn {% if categoria == 'diversos' %}active{% endif %}" href="?categoria=diversos" data-category="diversos">
      <span>üõçÔ∏è diversos</span>
    </a>
  </nav>
  
  <!-- INFO DA PAGINA√á√ÉO -->
  {% if produtos.object_list %}
  <div class="pagination-info">
    <p>Mostrando {{ produtos.start_index }}-{{ produtos.end_index }} de {{ produtos.paginator.count }} produtos</p>
  </div>
  {% endif %}
  
  <section class="products">
    {% for produto in produtos %}
      {% if produto.ativo == True %}
        <div class="card">
          <img src="{{ produto.imagem.url }}" alt="{{ produto.nome }} image">
          <h2>{{ produto.nome }}</h2>
          <p>{{ produto.descricao }}</p>
          <div class="price">R$ {{ produto.preco }}</div>
          <div class="price">Dispon√≠vel: {{ produto.quantidade_estoque }}</div>
          <a class="btn" href="https://wa.me/557981718236?text=Ol√°,+tenho+interesse+no+{{ produto.nome|urlencode }}" target="_blank">üí¨ Comprar pelo WhatsApp</a>
          <a class="btn add-to-cart" data-nome="{{ produto.nome }}" data-preco="{{ produto.preco|floatformat:2 }}">üõí Adicionar ao Carrinho</a>
        </div>
      {% endif %}
    {% empty %}
    <div style="text-align:center; width:100%;">Nenhum produto encontrado nesta categoria.</div>
    {% endfor %}
  </section>

  <!-- PAGINA√á√ÉO -->
  {% if produtos.paginator.num_pages > 1 %}
  <div class="pagination-container">
    <div class="pagination">
      
      <!-- Primeira p√°gina -->
      {% if produtos.has_previous %}
        <a href="?{% if query %}q={{ query }}&{% endif %}{% if categoria %}categoria={{ categoria }}&{% endif %}page=1" class="page-btn first">
          ‚Üû Primeira
        </a>
        <a href="?{% if query %}q={{ query }}&{% endif %}{% if categoria %}categoria={{ categoria }}&{% endif %}page={{ produtos.previous_page_number }}" class="page-btn prev">
          ‚Üê Anterior
        </a>
      {% endif %}

      <!-- N√∫meros das p√°ginas -->
      {% for page in page_range %}
        {% if page == '...' %}
          <span class="page-dots">...</span>
        {% elif page == current_page %}
          <span class="page-btn current">{{ page }}</span>
        {% else %}
          <a href="?{% if query %}q={{ query }}&{% endif %}{% if categoria %}categoria={{ categoria }}&{% endif %}page={{ page }}" class="page-btn">
            {{ page }}
          </a>
        {% endif %}
      {% endfor %}

      <!-- Pr√≥xima p√°gina -->
      {% if produtos.has_next %}
        <a href="?{% if query %}q={{ query }}&{% endif %}{% if categoria %}categoria={{ categoria }}&{% endif %}page={{ produtos.next_page_number }}" class="page-btn next">
          Pr√≥xima ‚Üí
        </a>
        <a href="?{% if query %}q={{ query }}&{% endif %}{% if categoria %}categoria={{ categoria }}&{% endif %}page={{ produtos.paginator.num_pages }}" class="page-btn last">
          √öltima ‚Ü†
        </a>
      {% endif %}

    </div>
    
    <!-- Info adicional -->
    <div class="pagination-summary">
      P√°gina {{ produtos.number }} de {{ produtos.paginator.num_pages }}
    </div>
  </div>
  {% endif %}

  <!-- Bot√£o flutuante do carrinho -->
  <div id="cart-icon" onclick="toggleCart()">
    üõí <span id="cart-count">0</span>
  </div>

  <!-- Sidebar do carrinho -->
  <div id="cart-sidebar">
    <h2>üõçÔ∏è Carrinho</h2>
    <div id="cart-items"></div>
    <div id="cart-total"></div>
    <button class="btn" onclick="sendCartToWhatsApp()">üí¨ Enviar Pedido no WhatsApp</button>
    <p><br></p>
    <button class="btn" onclick="clearCart()">üóëÔ∏è Limpar Carrinho</button>
  </div>
  <div id="cart-overlay" onclick="toggleCart()"></div>

  <footer>
    <a class="btn" href="{% url 'admin:index' %}" target="_blank">üîê Login Admin</a>
    <p>contato@omnisistems.com.br</p>
  </footer>

  <script>
    // Menu lateral
    function toggleMenu() {
      const menu = document.getElementById("menu");
      const overlay = document.getElementById("overlay");
      menu.classList.toggle("show");
      overlay.classList.toggle("show");
    }
    function closeMenu() {
      document.getElementById("menu").classList.remove("show");
      document.getElementById("overlay").classList.remove("show");
    }

    // -------------------------
    // CARRINHO
    // -------------------------
    let cart = JSON.parse(localStorage.getItem("cart")) || [];

    function renderCart() {
      const cartItems = document.getElementById("cart-items");
      const cartTotal = document.getElementById("cart-total");
      const cartCount = document.getElementById("cart-count");
      cartItems.innerHTML = "";

      if (cart.length === 0) {
        cartItems.innerHTML = "<p>Seu carrinho est√° vazio.</p>";
        cartTotal.innerHTML = "";
        cartCount.textContent = "0";
        return;
      }

      let total = 0;
      let count = 0;

      cart.forEach((item, index) => {
        total += item.preco * item.quantidade;
        count += item.quantidade;
        cartItems.innerHTML += `
          <div>
            ${item.nome} - R$ ${item.preco.toFixed(2)} x ${item.quantidade}
            <button onclick="removeFromCart(${index})">‚ùå</button>
          </div>
        `;
      });

      cartTotal.innerHTML = `<h3>Total: R$ ${total.toFixed(2)}</h3>`;
      cartCount.textContent = count;
      localStorage.setItem("cart", JSON.stringify(cart));
    }

    function removeFromCart(index) {
      cart.splice(index, 1);
      renderCart();
    }

    // Adicionar ao carrinho
    document.querySelectorAll('.add-to-cart').forEach(btn => {
      btn.addEventListener('click', function() {
        const nome = this.dataset.nome;
        const preco = parseFloat(this.dataset.preco.replace(",", "."));
        const existing = cart.find(item => item.nome === nome);

        if (existing) {
          existing.quantidade += 1;
        } else {
          cart.push({ nome, preco, quantidade: 1 });
        }

        renderCart();
      });
    });

    function sendCartToWhatsApp() {
      if (cart.length === 0) {
        alert("Seu carrinho est√° vazio!");
        return;
      }

      let mensagem = "üõçÔ∏è Meu Pedido Bellafly:%0A%0A";
      let total = 0;

      cart.forEach(item => {
        mensagem += `‚Ä¢ ${item.nome} - R$ ${item.preco.toFixed(2)} x ${item.quantidade}%0A`;
        total += item.preco * item.quantidade;
      });

      mensagem += `%0Aüí∞ Total: R$ ${total.toFixed(2)}`;

      const telefone = "557981718236";
      const url = `https://wa.me/${telefone}?text=${mensagem}`;
      window.open(url, "_blank");
    }

    function toggleCart() {
      document.getElementById("cart-sidebar").classList.toggle("show");
      document.getElementById("cart-overlay").classList.toggle("show");
    }
    
    function clearCart() {
      if (confirm("Tem certeza que deseja limpar o carrinho?")) {
        cart = [];
        localStorage.removeItem("cart");
        renderCart();
      }
    }

    // Inicializa carrinho
    renderCart();
  </script>
</body>
</html>